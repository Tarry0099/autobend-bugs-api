<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Autobend Bug Tracker</title>
  <style>
    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ */
    .bug-item.done {
      color: grey;
      text-decoration: line-through;
    }
    .bug-item.done .erledigt-controls {
        display: none; /* Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ ÙˆÙ‚ØªÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ */
    }
    .erledigt-controls input, .erledigt-controls button {
        margin-left: 8px;
    }
    #bugList li {
        margin-bottom: 10px; /* Ú©Ù…ÛŒ ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ */
        padding: 5px;
        border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>
  <h1>ğŸ Autobend Bug Tracker</h1>

  <input id="bugText" placeholder="Fehlerbeschreibung eingeben" />
  <input id="userName" placeholder="Ihr Name" />
  <button onclick="submitBug()">Fehler melden</button>

  <h2>Fehlerliste</h2>
  <ul id="bugList"></ul>

  <script>
    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§Ú¯â€ŒÙ‡Ø§
    async function loadBugs() {
      try {
        const res = await fetch("/bugs");
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const bugs = await res.json();
        const list = document.getElementById("bugList");
        list.innerHTML = ""; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª Ù‚Ø¨Ù„ÛŒ

        bugs.forEach((bug) => {
          if (!bug || !bug.id || !bug.text || !bug.user) return; // Skip incomplete bugs

          const li = document.createElement("li");
          li.dataset.bugId = bug.id; // Ø°Ø®ÛŒØ±Ù‡ ID Ø¯Ø± Ø¯ÛŒØªØ§ Ø§ØªØ±ÛŒØ¨ÛŒÙˆØª Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¢Ø³Ø§Ù†
          li.classList.add('bug-item'); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ù„Ø§Ø³ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ§ÛŒÙ„â€ŒØ¯Ù‡ÛŒ

          // Ø¨Ø®Ø´ Ø§ØµÙ„ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§Ú¯ (Ø´Ù…Ø§Ø±Ù‡ØŒ Ù…ØªÙ†ØŒ Ú©Ø§Ø±Ø¨Ø±)
          let bugHtml = `<strong>${bug.id}. ${bug.text}</strong> (gemeldet von ${bug.user})`;

          if (bug.erledigt) {
            // Ø§Ú¯Ø± Ø¨Ø§Ú¯ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡
            li.classList.add("done");
            bugHtml += ` - <i>Erledigt von: ${bug.erledigtVon || 'Unbekannt'}</i>`; // Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù… Ø§Ù†Ø¬Ø§Ù…â€ŒØ¯Ù‡Ù†Ø¯Ù‡
          } else {
            // Ø§Ú¯Ø± Ø¨Ø§Ú¯ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡ - Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ "Erledigt"
            bugHtml += `
              <span class="erledigt-controls">
                <input type="text" id="resolver-${bug.id}" placeholder="Ihr Name (Erlediger)" size="15" oninput="checkInput(${bug.id})">
                <button id="button-${bug.id}" onclick="markAsDone(${bug.id})" disabled>Erledigt</button>
              </span>
            `;
          }

          li.innerHTML = bugHtml;
          list.appendChild(li);
        });
      } catch (error) {
        console.error("Fehler beim Laden der Bugs:", error);
        const list = document.getElementById("bugList");
        list.innerHTML = "<li>Fehler beim Laden der Bugliste. Bitte versuchen Sie es spÃ¤ter erneut.</li>";
      }
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ±ÙˆØ¯ÛŒ
    function checkInput(bugId) {
        const input = document.getElementById(`resolver-${bugId}`);
        const button = document.getElementById(`button-${bugId}`);
        if (input && button) {
            button.disabled = !input.value.trim();
        }
    }

    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø¨Ø§Ú¯ Ø¬Ø¯ÛŒØ¯
    async function submitBug() {
      const textInput = document.getElementById("bugText");
      const userInput = document.getElementById("userName");
      const text = textInput.value.trim();
      const user = userInput.value.trim();

      if (!text || !user) {
        alert("Bitte sowohl Fehlerbeschreibung als auch Namen eingeben.");
        return;
      }

      try {
        const res = await fetch("/bugs", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, user })
        });

        if (!res.ok) {
           const errorData = await res.json().catch(() => ({ error: 'Unbekannter Serverfehler' }));
           throw new Error(`Fehler vom Server: ${errorData.error || res.statusText}`);
        }

        // const newBug = await res.json(); // Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø§Ú¯ Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø³Ø±ÙˆØ±
        // Ø¨Ù‡ Ø¬Ø§ÛŒ Ù„ÙˆØ¯ Ú©Ù„ Ù„ÛŒØ³ØªØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒÙ… ÙÙ‚Ø· Ø¨Ø§Ú¯ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒÙ…
        // Ø§Ù…Ø§ Ø³Ø§Ø¯Ù‡â€ŒØªØ± Ø§Ø³Øª Ú©Ù‡ Ú©Ù„ Ù„ÛŒØ³Øª Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù„ÙˆØ¯ Ú©Ù†ÛŒÙ…:
        loadBugs();

        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ
        textInput.value = "";
        userInput.value = "";

      } catch (error) {
          console.error("Fehler beim Senden des Bugs:", error);
          alert(`Fehler beim Melden des Bugs: ${error.message}`);
      }
    }

    // <<<<<<< ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ø¹Ù„Ø§Ù…Øª Ø²Ø¯Ù† Ø¨Ø§Ú¯ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ >>>>>>>
    async function markAsDone(bugId) {
        const resolverInput = document.getElementById(`resolver-${bugId}`);
        const userName = resolverInput.value.trim();

        if (!userName) {
            alert("Bitte geben Sie Ihren Namen ein, um den Bug als erledigt zu markieren.");
            return;
        }

        try {
            const res = await fetch(`/bugs/${bugId}/erledigt`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ erledigtVonUser: userName }) // Ù†Ø§Ù… ÙÛŒÙ„Ø¯ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ø¨Ú©â€ŒØ§Ù†Ø¯ Ù…Ú† Ø¨Ø§Ø´Ø¯
            });

            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ error: 'Unbekannter Serverfehler beim Update' }));
                throw new Error(`Fehler vom Server beim Aktualisieren: ${errorData.error || res.statusText}`);
            }

            // const updatedBug = await res.json(); // Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø§Ú¯ Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯Ù‡
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØªØºÛŒÛŒØ±Ø§Øª
            loadBugs();

        } catch (error) {
            console.error("Fehler beim Markieren als Erledigt:", error);
            alert(`Fehler: ${error.message}`);
        }
    }

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§Ú¯â€ŒÙ‡Ø§ Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØµÙØ­Ù‡
    loadBugs();
  </script>
</body>
</html>
